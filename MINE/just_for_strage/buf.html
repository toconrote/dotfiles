<head>
<script src="jquery/jquery-1.11.3.min.js"></script>
<script src="jquery/jquery.cookie.js"></script>
<style>
.cf:before,
.cf:after {
  content: " ";
  display: table;
}
.cf:after {
  clear: both;
}
.cf {
  *zoom: 1;
}
.table {
  padding: 10px;
  border: 1px solid #d0d0d0;
  border-radius: 5px;
  float: left;
}
.sec {
  width: 60px;
  text-align: center;
}
li {
  list-style: none;
  margin-top: 5px;
}
#editmenu {
  display:none;
}
#editmenu.is-on {
  display:block;
}
</style>
</head>
<div id="turn" class="cf">
  <div class="table">
    <table>
      <tbody>
      </tbody>
    </table>
  </div>
</div>
<div style="margin-top: 50px">
  <div id="editmenu">
    <p>名<input type="text" id="addSkill"></p>
    <p>秒<input type="text" id="addSecond" style="width:50px"></p>
    <p><span style="color:orange">橙</span><input type="text" id="addDanger" style="width:50px"></p>
    <p><span style="color:red">赤</span><input type="text" id="addCritical" style="width:50px"></p>
    <p><input type="button" value="追加" onclick="addFromDisp()"></p>
    <p>チェックの入った項目を<input type="button" value="削除" onclick="del()"></p>
    <p><input type="button" value="cookie保存" onclick="saveCookie()"></p>
    <p><input type="button" value="cookie読込" onclick="loadCookie()"></p>
    <p></p>
    <p><ul><li>名：名前</li><li>秒：全体の秒数</li><li>橙：オレンジ色になる残り秒数</li><li>赤：赤色になる残り秒数</li></ul></p>
  </div>
  <input type="button" value="項目編集表示切替" onclick="toggleEditMenu()">
</div>
<script>
var t = {}; //タイマーの配列
var data = []; //項目の内容データ

//初期化処理、クッキーがあるなら読み込み
if($.cookie("data")){
  loadCookie();
} else {
  add("ヘビチャ", 90, 30, 15);
}

//critical入力後エンター
$("#addCritical").keydown(function(e){
    if(e.which=="13")addFromDisp();
    })

////以下関数群
//タイマーをセット
function setT(tar){
  target = $("#"+tar.id).parent().prev().children().first().css("color", "black");
  if(t[tar.id])clearInterval(t[tar.id]);
  t[tar.id] = setInterval(count, 100, target, new Date(), tar.id);
}
//タイマーのコールバック
function count(target, date, id){
  s = data[id]["second"];
  d = data[id]["danger"];
  c = data[id]["critical"];
  cs = Math.floor((new Date() - date) / 1000);
  target.text((s-cs) + '秒');

  if(s-cs==d){
    target.css("color", "orange");
  }
  if(s-cs==c){
    target.css("color", "red");
  }

  if(s-cs==0){
    clearInterval(t[id]);
    target.text('0秒');
  }
}
//画面から項目追加(画面の情報をadd関数に送ってクリアするだけ)
function addFromDisp() {
  skill = $("#addSkill").val();
  second = $("#addSecond").val();
  danger = $("#addDanger").val();
  critical = $("#addCritical").val();
  if(skill=="")return;
  if(second=="" || isNaN(second))return;
  if(danger=="" || isNaN(danger))return;
  if(critical=="" || isNaN(critical))return;
  add(skill, second, danger, critical);
  $("#addSkill").val("").focus();
  $("#addSecond").val("");
  $("#addDanger").val("");
  $("#addCritical").val("");
}
//追加処理本体
function add(skill, second, danger, critical) {
  addid = getEmptyID();
  $("tbody").append("<tr>").children().last().append('<td><input type="checkbox">'+skill+
      '</td><td class="sec"><span style="font-weight:bold;">'+second+
      '秒</span></td><td><input id="'+addid+'" type="button" onclick="setT(this)" value="更新"></td>');
  data[addid]={};
  data[addid]["skill"] = skill;
  data[addid]["second"] = second;
  data[addid]["danger"] = danger;
  data[addid]["critical"] = critical;
}
//削除処理関数
function del() {
  trs = $("tbody").children();
  len = trs.length;
  var i;
  for(i=len-1;i>=0;i--){
    if($(trs[i]).find("input[type='checkbox']").prop("checked")){
      trs[i].remove();
    }
  }
}
//空きid取得関数
function getEmptyID() {
  buf = [];
  $("tbody").find("input[id]").each(function(){
      buf[parseInt($(this).attr("id"))] = true;
      });
  len = buf.length;
  blankid = len;
  var i;
  for(i=0;i<len-1;i++){
    if(!buf[i]){
      blankid = i;
      break;
    }
  }
  return blankid;
}
//クッキーを保存
function saveCookie() {
  /*
  $("tbody").filter("[id]").each(function(){
        id = parseInt($(this).attr("id"));
      })
      */
  datastr = JSON.stringify(data);
  $.cookie("data", datastr, {"expires":30});
}
//クッキーを読み込み
function loadCookie() {
  cookiedata = JSON.parse($.cookie("data"));
  $("tbody").empty();
  var i;
  for(i=0;i<cookiedata.length;i++){
    add(cookiedata[i]["skill"], cookiedata[i]["second"], cookiedata[i]["danger"], cookiedata[i]["critical"]);
  }
}
//編集メニュートグル
function toggleEditMenu() {
  $("#editmenu").toggleClass("is-on")
}
</script>
